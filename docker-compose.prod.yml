# ============================================================================
# SustainSutra - Production Docker Compose (NO SECRETS VERSION)
# ============================================================================
# IMPORTANT: This version does NOT require Docker Secrets
# All sensitive values are passed as environment variables
#
# ============================================================================
# DEPLOYMENT INSTRUCTIONS
# ============================================================================
#
# PRE-DEPLOYMENT CHECKLIST:
# [ ] Update environment variables below with your values
# [ ] In Portainer, deploy this stack
# [ ] Verify all services start successfully
#
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # FRONTEND SERVICE
  # ============================================================================
  frontend:
    image: amitkr64/sustainsutra-frontend:latest
    container_name: sustainsutra-frontend
    restart: unless-stopped

    ports:
      - "8085:80"

    environment:
      # API Configuration
      - VITE_API_URL=http://backend:5000
      - NODE_ENV=production

      # Feature Flags
      - VITE_ENABLE_ANALYTICS=${ENABLE_ANALYTICS:-false}
      - VITE_ENABLE_PWA=true

      # Error Tracking
      - VITE_SENTRY_DSN=${SENTRY_DSN:-}
      - VITE_SENTRY_ENVIRONMENT=production

      # Payment Gateway
      - VITE_RAZORPAY_KEY=${RAZORPAY_KEY:-}

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    labels:
      - "com.sustainsutra.service=frontend"
      - "com.sustainsutra.version=1.0.0"

    networks:
      - sustainsutra-network

    depends_on:
      backend:
        condition: service_healthy

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # BACKEND SERVICE
  # ============================================================================
  backend:
    image: amitkr64/sustainsutra-backend:latest
    container_name: sustainsutra-backend
    restart: unless-stopped

    ports:
      - "5000:5000"

    environment:
      # Server Configuration
      - NODE_ENV=production
      - PORT=5000
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8085}

      # Database Configuration
      - MONGO_URI=mongodb://mongo:27017/sustainsutra
      - REQUIRE_DB=false
      - DEMO_MODE=false

      # Security (IMPORTANT: Change these in production!)
      - JWT_SECRET=${JWT_SECRET:-your_super_secret_jwt_key_change_this_in_production}
      - JWT_EXPIRE=${JWT_EXPIRE:-7d}

      # CORS Configuration
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:8085}

      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-15}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}

      # File Upload Configuration
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
      - UPLOAD_DIR=/app/uploads

      # Email Configuration (Optional)
      - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_SECURE=false
      - EMAIL_USER=${EMAIL_USER:-your-email@gmail.com}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-your-app-password}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@sustainsutra.in}

      # Payment Gateway (Optional)
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID:-}
      - RAZORPAY_KEY_SECRET=${RAZORPAY_KEY_SECRET:-}

      # Error Tracking (Optional)
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=production

      # Demo Mode (should be false in production)
      - DEMO_MODE=false

      # AI API Keys (Optional)
      - ZHIPU_API_KEY=${ZHIPU_API_KEY:-}

    volumes:
      - uploads-data:/app/uploads
      - logs-data:/app/logs

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    labels:
      - "com.sustainsutra.service=backend"
      - "com.sustainsutra.version=1.0.0"

    networks:
      - sustainsutra-network

    depends_on:
      mongo:
        condition: service_healthy

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # MONGODB SERVICE
  # ============================================================================
  mongo:
    image: mongo:7
    container_name: sustainsutra-mongo
    restart: unless-stopped

    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
      - mongo-backup:/data/backup

    environment:
      # Database Configuration
      - MONGO_INITDB_DATABASE=sustainsutra
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-securePassword123}
      - MONGO_INITDB_PWD_LENGTH=8

      # Enable authentication
      - MONGO_INITDB_PWD_AUTHENTICATION=yes

      # Enable journaling for data durability
      - MONGO_JOURNAL=true

      # Disable telemetry (optional)
      - MONGO_DISABLE_PREALLOC=0
      - MONGO_DISABLE_JOURNAL=0
      - MONGO_NOJOIN=0
      - MONGO_NOPREALLOC=0

    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

    labels:
      - "com.sustainsutra.service=database"
      - "com.sustainsutra.version=7.0"
      - "com.sustainsutra.description=MongoDB Database"

    networks:
      - sustainsutra-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  sustainsutra-network:
    name: sustainsutra-network
    driver: bridge

volumes:
  # Primary database storage
  mongo-data:
    name: sustainsutra-mongo-data
    driver: local

  # Database configuration
  mongo-config:
    name: sustainsutra-mongo-config
    driver: local

  # Backup storage
  mongo-backup:
    name: sustainsutra-mongo-backup
    driver: local

  # Uploaded files storage
  uploads-data:
    name: sustainsutra-uploads-data
    driver: local

  # Application logs
  logs-data:
    name: sustainsutra-logs-data
    driver: local

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
