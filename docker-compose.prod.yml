# ============================================================================
# SustainSutra - Production Docker Compose Configuration
# ============================================================================
# Version: 1.0.0
# Purpose: Production deployment for Portainer
#
# PRE-DEPLOYMENT CHECKLIST:
# [ ] Create Docker Secrets for all sensitive values
# [ ] Generate secure JWT_SECRET (openssl rand -base64 64)
# [ ] Configure DOMAIN environment variable
# [ ] Set up SSL/TLS certificates (or use Traefik)
# [ ] Configure backup strategy for volumes
# [ ] Test health checks locally first
#
# DEPLOYMENT INSTRUCTIONS:
# 1. Copy this file to your Portainer server
# 2. Create secrets in Portainer (see secrets section below)
# 3. Set environment variables in Portainer stack configuration
# 4. Deploy the stack
# 5. Verify all health checks pass
#
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # FRONTEND SERVICE
  # ============================================================================
  frontend:
    image: amitkr64/sustainsutra-frontend:latest
    container_name: sustainsutra-frontend
    restart: unless-stopped

    # Port mapping - adjust if using reverse proxy
    ports:
      - "${FRONTEND_PORT:-8085}:80"

    # Environment Variables
    environment:
      # API Configuration
      - VITE_API_URL=${API_URL:-http://backend:5000}

      # Application Environment
      - NODE_ENV=production

      # Feature Flags
      - VITE_ENABLE_ANALYTICS=${ENABLE_ANALYTICS:-false}
      - VITE_ENABLE_PWA=true

      # Error Tracking
      - VITE_SENTRY_DSN=${SENTRY_DSN:-}
      - VITE_SENTRY_ENVIRONMENT=production

      # Payment Gateway (optional - for client-side integration)
      - VITE_RAZORPAY_KEY=${RAZORPAY_KEY_ID:-}

    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    # Labels for Portainer organization
    labels:
      - "com.sustainsutra.service=frontend"
      - "com.sustainsutra.version=1.0.0"
      - "com.sustainsutra.description=Frontend Web Application"

    # Networks
    networks:
      - sustainsutra-network

    # Dependencies
    depends_on:
      backend:
        condition: service_healthy

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # BACKEND SERVICE
  # ============================================================================
  backend:
    image: amitkr64/sustainsutra-backend:latest
    container_name: sustainsutra-backend
    restart: unless-stopped

    # Port mapping - adjust if using reverse proxy
    ports:
      - "${BACKEND_PORT:-5000}:5000"

    # Environment Variables
    environment:
      # Server Configuration
      - NODE_ENV=production
      - PORT=5000
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8085}

      # Database Configuration
      - MONGO_URI=mongodb://mongo:27017/sustainsutra
      - REQUIRE_DB=false

      # Security (CRITICAL - Use secrets)
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - JWT_EXPIRE=${JWT_EXPIRE:-7d}

      # CORS Configuration
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:8085}

      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-15}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}

      # File Upload Configuration
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
      - UPLOAD_DIR=/app/uploads

      # Email Configuration (optional)
      - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_SECURE=false
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASS_FILE=/run/secrets/email_password
      - EMAIL_FROM=${EMAIL_FROM:-noreply@sustainsutra.in}

      # Payment Gateway (optional)
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID:-}
      - RAZORPAY_KEY_SECRET_FILE=/run/secrets/razorpay_secret

      # Error Tracking (optional)
      - SENTRY_DSN_FILE=/run/secrets/sentry_dsn
      - SENTRY_ENVIRONMENT=production

      # Demo Mode (set to false in production)
      - DEMO_MODE=false

      # AI API Keys (optional)
      - ZHIPU_API_KEY=${ZHIPU_API_KEY:-}
      - ZHIPU_BASE_URL=${ZHIPU_BASE_URL:-https://api.z.ai/api/coding/paas/v4}

    # Docker Secrets
    secrets:
      - jwt_secret
      - email_password
      - razorpay_secret
      - sentry_dsn

    # Volume Mounts
    volumes:
      - uploads-data:/app/uploads
      - logs-data:/app/logs

    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    # Labels for Portainer organization
    labels:
      - "com.sustainsutra.service=backend"
      - "com.sustainsutra.version=1.0.0"
      - "com.sustainsutra.description=Backend API Server"

    # Networks
    networks:
      - sustainsutra-network

    # Dependencies
    depends_on:
      mongo:
        condition: service_healthy

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # MONGODB SERVICE
  # ============================================================================
  mongo:
    image: mongo:7
    container_name: sustainsutra-mongo
    restart: unless-stopped

    # Environment Variables
    environment:
      # Enable authentication
      - MONGO_INITDB_ROOT_USERNAME_FILE=/run/secrets/mongo_root_username
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo_root_password
      - MONGO_INITDB_DATABASE=sustainsutra

      # Enable journaling for data durability
      - MONGO_JOURNAL=true

      # Disable telemetry (optional)
      - MONGO_DISABLE_PREALLOC=0
      - MONGO_DISABLE_JOURNAL=0
      - MONGO_NOJOIN=0
      - MONGO_NOPREALLOC=0

    # Docker Secrets
    secrets:
      - mongo_root_username
      - mongo_root_password

    # Volume Mounts
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
      - mongo-backup:/data/backup

    # Health Check
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Resource Limits
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s

    # Labels for Portainer organization
    labels:
      - "com.sustainsutra.service=database"
      - "com.sustainsutra.version=7.0"
      - "com.sustainsutra.description=MongoDB Database"

    # Networks
    networks:
      - sustainsutra-network

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # MONGODB BACKUP SERVICE (Optional - Recommended for Production)
  # ============================================================================
  mongo-backup:
    image: mongo:7
    container_name: sustainsutra-mongo-backup
    restart: "no"

    # Environment Variables
    environment:
      - MONGO_URI=mongodb://mongo:27017/sustainsutra
      - MONGO_INITDB_ROOT_USERNAME_FILE=/run/secrets/mongo_root_username
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo_root_password
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}

    # Docker Secrets
    secrets:
      - mongo_root_username
      - mongo_root_password

    # Volume Mounts
    volumes:
      - mongo-backup:/backup
      - ./scripts/backup.sh:/backup.sh:ro

    # Backup Command
    command: >
      sh -c "
        chmod +x /backup.sh &&
        echo 'Installing cron...' &&
        apk add --no-cache cron &&
        echo '${BACKUP_SCHEDULE:-0 2 * * *} /backup.sh' | crontab - &&
        echo 'Starting cron daemon...' &&
        crond -f -l 2
      "

    # Labels for Portainer organization
    labels:
      - "com.sustainsutra.service=backup"
      - "com.sustainsutra.description=Automated MongoDB Backup"

    # Networks
    networks:
      - sustainsutra-network

    # Dependencies
    depends_on:
      mongo:
        condition: service_healthy

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  sustainsutra-network:
    name: sustainsutra-network
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: sustainsutra-br0
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
    labels:
      - "com.sustainsutra.network=production"

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  # Primary database storage
  mongo-data:
    name: sustainsutra-mongo-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_DATA_PATH:-/var/lib/sustainsutra/mongo/data}
    labels:
      - "com.sustainsutra.volume=database"
      - "com.sustainsutra.backup.required=true"

  # Database configuration
  mongo-config:
    name: sustainsutra-mongo-config
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_CONFIG_PATH:-/var/lib/sustainsutra/mongo/config}
    labels:
      - "com.sustainsutra.volume=config"

  # Backup storage
  mongo-backup:
    name: sustainsutra-mongo-backup
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MONGO_BACKUP_PATH:-/var/lib/sustainsutra/mongo/backup}
    labels:
      - "com.sustainsutra.volume=backup"
      - "com.sustainsutra.backup.schedule=daily"

  # Uploaded files storage
  uploads-data:
    name: sustainsutra-uploads-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${UPLOADS_PATH:-/var/lib/sustainsutra/uploads}
    labels:
      - "com.sustainsutra.volume=uploads"
      - "com.sustainsutra.backup.required=true"

  # Application logs
  logs-data:
    name: sustainsutra-logs-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_PATH:-/var/lib/sustainsutra/logs}
    labels:
      - "com.sustainsutra.volume=logs"

# ============================================================================
# SECRETS
# ============================================================================
# IMPORTANT: These secrets must be created in Portainer BEFORE deployment!
# Use the Portainer UI: Secrets -> Add Secret
# Or create them manually: echo "value" | docker secret create name -
#
# SECRET GENERATION COMMANDS:
# jwt_secret:           openssl rand -base64 64
# email_password:       (Get from Google App Passwords)
# razorpay_secret:      (Get from Razorpay Dashboard)
# sentry_dsn:           (Get from Sentry Dashboard)
# mongo_root_username:  echo "admin" | docker secret create mongo_root_username -
# mongo_root_password:  openssl rand -base64 32
#
secrets:
  jwt_secret:
    external: true
    name: sustainsutra_jwt_secret

  email_password:
    external: true
    name: sustainsutra_email_password

  razorpay_secret:
    external: true
    name: sustainsutra_razorpay_secret

  sentry_dsn:
    external: true
    name: sustainsutra_sentry_dsn

  mongo_root_username:
    external: true
    name: sustainsutra_mongo_username

  mongo_root_password:
    external: true
    name: sustainsutra_mongo_password

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
