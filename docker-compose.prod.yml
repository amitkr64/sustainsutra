# ============================================================================
# SustainSutra - Production Docker Compose (BUILD FROM GITHUB)
# ============================================================================
# IMPORTANT: This configuration builds from GitHub source
# This ensures you get the latest fixed code with corrected package.json
#
# DEPLOYMENT INSTRUCTIONS:
# 1. In Portainer: Stacks â†’ Add Stack
# 2. Repository URL: https://github.com/amitkr64/sustainsutra.git
# 3. Branch: main
# 4. Compose Path: docker-compose.prod.yml
# 5. Enable "Auto-build"
# 6. Deploy!
#
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # FRONTEND SERVICE (BUILD FROM GITHUB)
  # ============================================================================
  frontend:
    build:
      context: https://github.com/amitkr64/sustainsutra.git#main
      dockerfile: Dockerfile
    container_name: sustainsutra-frontend
    restart: unless-stopped

    ports:
      - "${FRONTEND_PORT:-8085}:80"

    environment:
      # API Configuration
      - VITE_API_URL=${API_URL:-http://backend:5000}
      - NODE_ENV=production

      # Feature Flags
      - VITE_ENABLE_ANALYTICS=${ENABLE_ANALYTICS:-false}
      - VITE_ENABLE_PWA=true

      # Error Tracking
      - VITE_SENTRY_DSN=${SENTRY_DSN:-}
      - VITE_SENTRY_ENVIRONMENT=production

      # Payment Gateway
      - VITE_RAZORPAY_KEY=${RAZORPAY_KEY_ID:-}

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    labels:
      - "com.sustainsutra.service=frontend"
      - "com.sustainsutra.version=1.0.0"

    networks:
      - sustainsutra-network

    depends_on:
      backend:
        condition: service_healthy

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # BACKEND SERVICE (BUILD FROM GITHUB)
  # ============================================================================
  backend:
    build:
      context: https://github.com/amitkr64/sustainsutra.git#main
      dockerfile: backend/Dockerfile
    container_name: sustainsutra-backend
    restart: unless-stopped

    ports:
      - "${BACKEND_PORT:-5000}:5000"

    environment:
      # Server Configuration
      - NODE_ENV=production
      - PORT=5000
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8085}

      # Database Configuration
      - MONGO_URI=mongodb://mongo:27017/sustainsutra
      - REQUIRE_DB=false
      - DEMO_MODE=false

      # Security (using Docker Secrets)
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - JWT_EXPIRE=${JWT_EXPIRE:-7d}

      # CORS Configuration
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:8085}

      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-15}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}

      # File Upload Configuration
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
      - UPLOAD_DIR=/app/uploads

      # Email Configuration
      - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_SECURE=false
      - EMAIL_USER=${EMAIL_USER:-}
      - EMAIL_PASS_FILE=/run/secrets/email_password
      - EMAIL_FROM=${EMAIL_FROM:-noreply@sustainsutra.in}

      # Payment Gateway
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID:-}
      - RAZORPAY_KEY_SECRET_FILE=/run/secrets/razorpay_secret

      # Error Tracking
      - SENTRY_DSN_FILE=/run/secrets/sentry_dsn
      - SENTRY_ENVIRONMENT=production

    secrets:
      - jwt_secret
      - email_password
      - razorpay_secret
      - sentry_dsn

    volumes:
      - uploads-data:/app/uploads
      - logs-data:/app/logs

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    labels:
      - "com.sustainsutra.service=backend"
      - "com.sustainsutra.version=1.0.0"

    networks:
      - sustainsutra-network

    depends_on:
      mongo:
        condition: service_healthy

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # MONGODB SERVICE
  # ============================================================================
  mongo:
    image: mongo:7
    container_name: sustainsutra-mongo
    restart: unless-stopped

    environment:
      # Enable authentication
      - MONGO_INITDB_ROOT_USERNAME_FILE=/run/secrets/mongo_root_username
      - MONGO_INITDB_ROOT_PASSWORD_FILE=/run/secrets/mongo_root_password
      - MONGO_INITDB_DATABASE=sustainsutra

      # Enable journaling for data durability
      - MONGO_JOURNAL=true

    secrets:
      - mongo_root_username
      - mongo_root_password

    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
      - mongo-backup:/data/backup

    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    labels:
      - "com.sustainsutra.service=database"
      - "com.sustainsutra.version=7.0"

    networks:
      - sustainsutra-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  sustainsutra-network:
    name: sustainsutra-network
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  # Primary database storage
  mongo-data:
    name: sustainsutra-mongo-data
    driver: local

  # Database configuration
  mongo-config:
    name: sustainsutra-mongo-config
    driver: local

  # Backup storage
  mongo-backup:
    name: sustainsutra-mongo-backup
    driver: local

  # Uploaded files storage
  uploads-data:
    name: sustainsutra-uploads-data
    driver: local

  # Application logs
  logs-data:
    name: sustainsutra-logs-data
    driver: local

# ============================================================================
# SECRETS (Create in Portainer before deploying)
# ============================================================================
# IMPORTANT: These secrets must exist in Portainer before deployment!

secrets:
  jwt_secret:
    external: true
    name: sustainsutra_jwt_secret

  email_password:
    external: true
    name: sustainsutra_email_password

  razorpay_secret:
    external: true
    name: sustainsutra_razorpay_secret

  sentry_dsn:
    external: true
    name: sustainsutra_sentry_dsn

  mongo_root_username:
    external: true
    name: sustainsutra_mongo_username

  mongo_root_password:
    external: true
    name: sustainsutra_mongo_password

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
