# ============================================================================
# SustainSutra - Local Testing Configuration
# ============================================================================
# Purpose: Test production configuration locally before Portainer deployment
# Usage: docker-compose -f docker-compose.test.yml up --build
#
# Differences from Production:
# - Builds from local source instead of pulling images
# - Uses local .env file instead of external secrets
# - Exposes more ports for debugging
# - No resource limits (for development comfort)
# - All logs output to console
#
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # FRONTEND SERVICE (Local Build)
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sustainsutra-frontend-test
    restart: unless-stopped

    ports:
      - "8085:80"

    environment:
      - VITE_API_URL=http://localhost:5000
      - NODE_ENV=development
      - VITE_ENABLE_ANALYTICS=false
      - VITE_ENABLE_PWA=true

    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - sustainsutra-test-network

    depends_on:
      backend:
        condition: service_healthy

  # ============================================================================
  # BACKEND SERVICE (Local Build)
  # ============================================================================
  backend:
    build:
      context: backend
      dockerfile: Dockerfile
    container_name: sustainsutra-backend-test
    restart: unless-stopped

    ports:
      - "5000:5000"

    environment:
      # Server Configuration
      - NODE_ENV=development
      - PORT=5000
      - FRONTEND_URL=http://localhost:8085

      # Database Configuration
      - MONGO_URI=mongodb://mongo:27017/sustainsutra
      - REQUIRE_DB=false
      - DEMO_MODE=false

      # Security (TESTING ONLY - Not for production!)
      - JWT_SECRET=test_jwt_secret_for_local_development_only_do_not_use_in_production
      - JWT_EXPIRE=7d

      # CORS Configuration
      - CORS_ORIGIN=http://localhost:8085

      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_WINDOW=15
      - RATE_LIMIT_MAX_REQUESTS=100

      # File Upload Configuration
      - MAX_FILE_SIZE=10485760
      - UPLOAD_DIR=/app/uploads

      # Email Configuration (Optional - leave blank for testing)
      - EMAIL_HOST=
      - EMAIL_PORT=
      - EMAIL_SECURE=false
      - EMAIL_USER=
      - EMAIL_PASS=
      - EMAIL_FROM=noreply@sustainsutra.in

      # Payment Gateway (Optional)
      - RAZORPAY_KEY_ID=
      - RAZORPAY_KEY_SECRET=

      # Error Tracking (Optional)
      - SENTRY_DSN=
      - SENTRY_ENVIRONMENT=development

    # Volume Mounts
    volumes:
      - uploads-data:/app/uploads
      - logs-data:/app/logs

    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - sustainsutra-test-network

    depends_on:
      mongo:
        condition: service_healthy

  # ============================================================================
  # MONGODB SERVICE
  # ============================================================================
  mongo:
    image: mongo:7
    container_name: sustainsutra-mongo-test
    restart: unless-stopped

    environment:
      # No authentication for local testing
      - MONGO_INITDB_DATABASE=sustainsutra

    # Volume Mounts
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb

    # Health Check
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - sustainsutra-test-network

    # Expose MongoDB port for debugging (optional)
    ports:
      - "27017:27017"

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  sustainsutra-test-network:
    name: sustainsutra-test-network
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  mongo-data:
    name: sustainsutra-test-mongo-data
    driver: local

  mongo-config:
    name: sustainsutra-test-mongo-config
    driver: local

  uploads-data:
    name: sustainsutra-test-uploads-data
    driver: local

  logs-data:
    name: sustainsutra-test-logs-data
    driver: local
